parameters:
  - name: action
    type: string
  - name: environment
    type: string

jobs:
  - job: TerragruntJob
    displayName: "Terragrunt ${{ parameters.action }} (${{ parameters.environment }})"
    pool:
      name: aws_host
    steps:
      - checkout: self

      - ${{ if eq(parameters.action, 'fmt') }}:
          - script: |
              cd terragrunt/${{ parameters.environment }}
              terragrunt hclfmt --check
            displayName: "Terragrunt Format Check"

      - ${{ if eq(parameters.action, 'plan') }}:
          - script: |
              cd terragrunt/${{ parameters.environment }}
              terragrunt plan-all
            displayName: "Terragrunt Plan-All"

      - ${{ if eq(parameters.action, 'apply') }}:
          - script: |
              cd terragrunt/${{ parameters.environment }}
              terragrunt apply-all -auto-approve
            displayName: "Terragrunt Apply-All"
            condition: eq(variables['Build.Reason'], 'Manual')
